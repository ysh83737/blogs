# Javascript运行机制
本文是作者学习过程中的总结，关于Javascript运行机制、事件循环的文章有很多，本人经过阅读、加以理解，写下此文作为学习总结。水平有限，欢迎指错。

## 一、线程与进程
### （一） Javascript单线程执行
我们都知道JS是单线程的脚本语言，在一个时间里只能做一件事，先执行前面的事件，再执行后面的事件，前后会形成阻塞。

显而易见，JS存在着这些缺点：
- 耗时任务会拖延后续的任务执行
- 无法充分利用CPU的计算能力，很难承担复杂的、耗时的任务

听起来这是一个很低效的设计。那么，为什么会如此设计？

经过阅读各路文章，我理解这样设计的优点有：
- 单线程执行让程序的执行变得简单可控。代码书写的顺序，就是执行顺序。
- 从应用场景考虑，JS的核心就是操作页面DOM。而单线程JS，让操作DOM的结果更明确。假设有多个JS线程，它们同时操作同一个DOM，应该以哪个结果为准、哪个优先？

综合来看，JS必须是一门单线程语言，并且在未来这个特点也不会改变。
### （二）进程与线程
在进一步理解JS的运行机制之前，有必要先了解进程和线程的基本知识。

首先理解一句话：**进程是CPU资源分配的最小单位；线程是CPU调度的最小单位**。

程序运行需要资源（比如内存），那么当程序运行时，CPU需要为其分配一定的资源形成一个进程，程序处理后，进程结束，CPU释放资源。

程序在进程中运行时，它需要分成多个子任务同时执行，以提高运行效率，这时候就需要多线程。把不同的任务交给不同的线程执行，这些线程共享进程的资源。也就是说，CPU分配资源给进程，进程中的子线程利用这些资源分别执行任务。

因此，一台设备运行时，基本都会有多个进程，每个进程里也会有多个线程。
> 举个形象的例子：CPU就像一座工厂；而进程就像是工厂的车间，一个车间完成一件事情；车间里有许多工人，这就好比是线程，工人之间协同完成这件事情。工厂给车间分配空间、设备等资源，车间内的工人只能利用车间所有的资源去完成自己的任务。
### （三）多进程与多线程
- 多进程：在同一个时间里，同一个计算机系统中如果允许两个或两个以上的进程处于运行状态。多进程带来的好处是明显的，比如你可以听歌的同时，打开编辑器敲代码，编辑器和听歌软件的进程之间丝毫不会相互干扰。
- 多线程：一个程序中可以同时运行多个不同的线程来执行不同的任务，也就是说允许单个程序创建多个并行执行的线程来完成各自的任务。
### （四）浏览器的进程和线程
以Chrome浏览器中为例，它是一个多进程多线程的程序。当打开一个Tab页时，其实就是创建了一个进程，一个进程中可以有多个线程。每个进程中，必然包含以下线程：
- GUI渲染线程
- JS引擎线程
- 定时触发器线程
- 事件触发线程
- 异步http请求线程
#### 1 GUI渲染线程
- 主要负责页面的渲染，解析HTML、CSS，构建DOM树，布局和绘制等。
- 当界面需要重绘或者由于某种操作引发回流时，将执行该线程。
- 该线程与JS引擎线程互斥，当执行JS引擎线程时，GUI渲染会被挂起，当任务队列空闲时，主线程才会去执行GUI渲染。
#### 2 JS引擎线程
- 该线程当然是主要负责处理JavaScript脚本，执行代码。
- 也是主要负责执行准备好待执行的事件，即定时器计数结束，或者异步请求成功并正确返回时，将依次进入任务队列，等待JS引擎线程的执行。
- 当然，该线程与GUI渲染线程互斥，当JS引擎线程执行JavaScript脚本时间过长，将导致页面渲染的阻塞。
#### 3 定时器触发线程
- 负责执行异步定时器一类的函数的线程，如：setTimeout，setInterval。
- 主线程依次执行代码时，遇到定时器，会将定时器交给该线程处理，当计数完毕后，事件触发线程会将计数完毕后的事件加入到任务队列的尾部，等待JS引擎线程执行。
#### 4 事件触发线程
- 主要负责将准备好的事件交给JS引擎线程执行。
- 比如setTimeout定时器计数结束，ajax等异步请求成功并触发回调函数，或者用户触发点击事件时，该线程会将整装待发的事件依次加入到任务队列的队尾，等待JS引擎线程的执行。
#### 5 异步http请求线程
- 负责执行异步请求一类的函数的线程，如：Promise，axios，ajax等。
- 主线程依次执行代码时，遇到异步请求，会将函数交给该线程处理，当监听到状态码变更，如果有回调函数，事件触发线程会将回调函数加入到任务队列的尾部，等待JS引擎线程执行。
## 二、任务队列
单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。当程序执行一次网络请求，等待返回结果这个过程很慢，这时候CPU是闲置的，不可能等结果返回再往下执行。JS主线程可挂起这些等待任务，先运行后面的任务。当挂起的任务有了返回结果，再把挂起的任务继续执行下去，这就是“异步任务”的概念，与之相对则是“同步任务”。
- 同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务。
- 异步任务指的是，不进入主线程、而进入“任务队列”（task queue）的任务，只有“任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。
## 三、事件循环
### （一）宏任务Macro-Task与微任务Micro-Task
浏览器端事件循环中的异步队列有两种：宏任务队列和微任务队列。宏任务队列可以有多个，微任务队列只有一个。
- 常见的宏任务：script（整体代码）、setTimeout、setInterval、I/O 操作、UI渲染
- 常见的微任务: new Promise().then(回调)、MutationObserver(html5新特性)
宏任务和微任务的本质区别如下：
微任务：不需要特定的异步线程去执行，没有明确的异步任务去执行，只有回调；
宏任务：需要特定的异步线程去执行，有明确的异步任务去执行，有回调。
### （二）事件循环过程
### （四）宏任务微任务参照表
## 四、Node与浏览器
## 参考文献
进程与线程的一个简单解释 https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html